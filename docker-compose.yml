volumes:
  keycloak-db: { }
  keycloak-provisioning: { }

services:

  engine:
    image: ghcr.io/noumenadigital/images/engine:latest
    ports:
      - "12000:12000"
    volumes:
      - ./npl/src/main/yaml:/npl/yaml:ro
      - ./npl/src/main/npl-1.0:/npl/npl-1.0:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allow container to reach host machine
      - "localhost:host-gateway"  # Allow container to reach host's localhost
    environment:
      ENGINE_DEV_MODE: ${DEV_MODE:-false}
      # Trust both purchasing and supplier realms for federated identity
      # Accept both localhost (browser) and keycloak (Docker) hostnames
      ENGINE_ALLOWED_ISSUERS: >-
        http://localhost:11000/realms/purchasing,
        http://localhost:11000/realms/supplier,
        http://keycloak:11000/realms/purchasing,
        http://keycloak:11000/realms/supplier
      # Map localhost issuer to keycloak for JWKS fetching (engine can't reach host's localhost)
      ENGINE_JWT_ISSUER_BASE_URL_OVERRIDE_localhost:11000: http://keycloak:11000
      ENGINE_DB_URL: "jdbc:postgresql://engine-db:5432/engine"
      ENGINE_DB_USER: engine
      ENGINE_DB_PASSWORD: secret
      ENGINE_DB_HISTORY_USER: history
      ENGINE_DB_HISTORY_SCHEMA: history
      ENGINE_DB_READ_MODEL_USER: postgraphile
      # Removed ENGINE_ISSUER_OVERRIDE to allow token issuer-based routing
      ENGINE_NPL_MIGRATION_DIRECTORY_PATH: /npl
      SWAGGER_ENGINE_URL: http://localhost:12000
      # Swagger UI defaults to purchasing realm (can be changed in UI)
      SWAGGER_SECURITY_AUTH_URL: http://localhost:11000/realms/purchasing
      SWAGGER_SECURITY_CLIENT_ID: purchasing
      # CORS configuration for frontend access
      ENGINE_CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://localhost:3000"
    depends_on:
      engine-db:
        condition: service_started
      keycloak:
        condition: service_healthy
    healthcheck:
      test: curl -f http://localhost:12000/actuator/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 10

  engine-db:
    image: postgres:14.4-alpine
    mem_limit: 256m
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: engine
      ENGINE_DB_USER: engine
      ENGINE_DB_PASSWORD: secret
      HISTORY_DB_USER: history
      HISTORY_DB_PASSWORD: secret
      HISTORY_DB_SCHEMA: history
      READ_MODEL_DB_USER: postgraphile
      READ_MODEL_DB_PASSWORD: secret
    volumes:
      - ./db_init/db_init.sh:/docker-entrypoint-initdb.d/db_init.sh
    healthcheck:
      test: pg_isready -U postgres
      interval: 1s
      timeout: 5s
      retries: 50

  keycloak-provisioning:
    build:
      context: keycloak-provisioning
    command: /local.sh
    volumes:
      - keycloak-provisioning:/state
    env_file:
      - .env
    environment:
      KEYCLOAK_USER: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-welcome}
      KEYCLOAK_URL: http://keycloak:11000
      TF_VAR_default_password: ${SEED_TEST_USERS_PASSWORD:-Welcome123}
      TF_VAR_systemuser_secret: super-secret-system-security-safe
      TF_VAR_app_name: ${VITE_NC_KC_REALM:-poc}
    depends_on:
      keycloak:
        condition: service_healthy

  keycloak:
    image: quay.io/keycloak/keycloak:26.0.0
    command: |
      start-dev
      --spi-events-listener-jboss-logging-success-level=info
      --spi-events-listener-jboss-logging-error-level=error
      --hostname-strict=false
      --health-enabled=true
      --http-enabled=true
      --metrics-enabled=true
      --db=postgres
      --http-port=11000
    ports:
      - "11000:11000"
      - "9000:9000"
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-welcome}
      KC_DB_URL: jdbc:postgresql://keycloak-db/postgres
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: testing
      KC_HEALTH_ENABLED: "true"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: 11000
      KC_HOSTNAME_STRICT: "false"
    depends_on:
      keycloak-db:
        condition: service_started
    healthcheck:
      test: curl -f http://localhost:9000/health || exit 1
      interval: 5s
      timeout: 5s
      retries: 20

  keycloak-db:
    image: postgres:14.4-alpine
    mem_limit: 256m
    ports:
      - "5439:5432"
    volumes:
      - keycloak-db:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: testing
      ENV: DOCKER
    healthcheck:
      test: pg_isready -U postgres
      interval: 1s
      timeout: 5s
      retries: 50

